#!/usr/bin/env node
var TransformOMatic = require('../lib/transform');
var stdout = require('../lib/stdout');

var usage = '\nPerform streaming data transformations on remote csv files.\n';
usage += 'More details: http://datapipes.okfnlabs.org\n\n';
usage += 'Usage: $0 [PIPELINE]';

var argv = require('optimist')
  .usage(usage)
  .demand(1)
  .argv
;

// web mode
var transformUrl = process.argv
  .splice(2)
  .join(' ')
  .replace(/(^(\/|\s)+|(\/|\s)+$)/g, '')
  .split('?')
;

var transformStr = transformUrl.shift();
var queryStr = transformUrl.join('?');
argv = queryStr.split('&').reduce(function(hash, str) {
  parts = str.split('=');
  hash[parts.shift()] = parts.join('=');
  return hash;
}, {});

transformStr = TransformOMatic.rejig(transformStr);
var transformers = TransformOMatic.pipeline(transformStr);
TransformOMatic.transform(stdout(), transformers, argv.url);
